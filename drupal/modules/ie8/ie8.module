<?php
/**
 * @file
 *
 * Downgrade and 'fix' core JS files so that they work in IE8.
 */


/**
 * Implements hook_library_info_alter().
 *
 * Downgrades required libraries to versions compatible with IE8.
 */
function ie8_library_info_alter(&$libraries, $extension) {
  if ($extension === 'core') {
    // Add a few dependencies to the HTML5shiv that is on all pages.
    $libraries['html5shiv']['dependencies'][] = 'ie8/respond';
    $libraries['html5shiv']['dependencies'][] = 'ie8/es5-shim';
    $libraries['html5shiv']['dependencies'][] = 'ie8/selectivizr';

    // Put classList polyfill at the top or else we have issues with CKEditor
    $libraries['classList']['header'] = TRUE;

    // Downgrade jQuery to 1.x releases
    _ie8_override_library('jquery', 'jquery.min', '1.11.3', $libraries);
    _ie8_override_library('domready', 'ready.min', '0.3.0', $libraries);
    _ie8_override_library('drupalSettings', 'drupalSettingsLoader', FALSE, $libraries);
    _ie8_override_library('drupal.ajax', 'ajax', FALSE, $libraries);
    _ie8_override_library('drupal.dialog.ajax', 'dialog.ajax', FALSE, $libraries);

    // Collapse need extra CSS to work
    _ie8_override_library('drupal.collapse', 'collapse', FALSE, $libraries);
    $libraries['drupal.collapse']['css']['component']['/' . drupal_get_path('module', 'ie8') . '/css/collapse.css'] = [];

    // Active links needs jQuery now.
    _ie8_override_library('drupal.active-link', 'active-link', FALSE, $libraries);
    $libraries['drupal.active-link']['dependencies'][] = 'core/jquery';
  }
  if ($extension === 'toolbar') {
    _ie8_override_library('toolbar.menu', 'toolbar.menu', FALSE, $libraries);
  }
  if ($extension === 'editor') {
    _ie8_override_library('drupal.editor', 'editor', FALSE, $libraries);
  }
  if ($extension === 'ckeditor') {
    _ie8_override_library('drupal.ckeditor.stylescombo.admin', 'ckeditor.stylescombo.admin', FALSE, $libraries);
  }
  if ($extension === 'history') {
    _ie8_override_library('mark-as-read', 'mark-as-read', FALSE, $libraries);
  }
}

/**
 * Replace stuff.
 *
 * @param $library_name
 * @param $filename
 * @param $version
 * @param $libraries
 */
function _ie8_override_library($library_name, $filename, $version = FALSE, &$libraries) {
  $lib = &$libraries[$library_name];
  $js_options = end($lib['js']);
  if (is_array($js_options)) {
    if ($version) {
      $lib['version'] = $version;
    }
    $lib['js'] = ['/' . drupal_get_path('module', 'ie8') . '/js/' . $filename . '.js' => $js_options];
  }
}
